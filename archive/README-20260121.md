# T480 control-plane lab

This repo defines the ThinkPad T480 as the **control-plane workstation** for a small Fedora/RHEL lab, with an Fedora Asahi-based server as the primary services and data hub. It is designed to demonstrate **senior-level, interview-defensible** Linux infrastructure, not just working configs.

## Lab overview

- T480: daily-driver workstation and control plane (Ansible, CI control, documentation).
- Asahi server (`srv-m1m`): main services and data node (Forgejo, Woodpecker, PostgreSQL, Prometheus/Grafana, Vaultwarden, etc.).
- Other nodes (raspi4, containers, cloud backups) hang off this pair as supporting infrastructure.

For a detailed map of hosts, services, and data flows, see `ARCHITECTURE.md`.

## Repo layout

Core directories under `infra/t480`:

- `ansible/` – playbooks, inventories, and roles for T480 and the wider lab.
- `runbooks/` – operational procedures (backup/restore, networking, security, systemd, etc.).
- `ADR/` – architecture decision records for non-trivial choices.
- `audits/` – system audit outputs and summarized system specs.
- `ci/` – CI configuration and helper scripts for validating this repo.
- `scripts/` – local helper scripts (e.g., audit and system-spec collection).
- `t480-system/` – T480-specific system description and specs.
- `troubleshoot/` – troubleshooting notes and structured investigations.

For machine-readable context (especially for AI tools), see `repo.md`.

## How to use this repo

- Treat this repo as the **single** source of truth for T480’s role in the lab and its automation.
- Capture any repeatable operational work as:
  - a `runbooks/RUNBOOK-*.md` entry, and
  - automation in `ansible/` or scripts where appropriate.
- Record non-obvious design or tradeoff decisions in `ADR/`.

Day-to-day, work from T480, commit to this repo, and use it to drive changes out to the Asahi server and other nodes.

## Governance

The rules for how to work in this repo, how to use AI, and how to evolve the lab are defined in `T480-CHARTER.md`. That charter is the governing law for this project.

## What we accomplished

The following baseline outcomes are in place and tracked in this repo:

- Defined `srv-m1m` as the primary services and data hub, managed from the T480 via an idempotent Ansible baseline playbook (`srv-m1m-baseline.yml`). [file:13]
- Standardized the filesystem layout so `/srv` is a bind mount of `/mnt/data/srv`, making capacity-tier service data available under a stable `/srv/...` path. [file:11][file:13]
- Normalized Forgejo and Vaultwarden service layouts:
  - Forgejo data is rooted at `/mnt/data/srv/forgejo` with correct `forgejo:forgejo` ownership. [file:13]
  - Vaultwarden data is rooted at `/mnt/data/srv/vaultwarden` and presented as `/srv/vaultwarden`, with a clean systemd unit running as the `vaultwarden` user. [file:13]
- Restored PostgreSQL to a stable state by removing experimental `PGDATA` overrides and keeping it on the distro-default data directory, while ensuring it is started and enabled by the baseline playbook. [file:11][file:12][file:13]

## Current system state

This section summarizes the current known state of the lab from the perspective of this repo and its documentation.

- `srv-m1m` is configured as an Asahi-based services node with a canonical `/srv` service root bind-mounted from `/mnt/data/srv`, hosting Forgejo, Vaultwarden, PostgreSQL, and `node_exporter` as systemd-managed services. [file:11][file:13]
- Vaultwarden runs under a dedicated `vaultwarden` user with its working directory at `/srv/vaultwarden` and configuration via `/etc/vaultwarden/vaultwarden.env`, aligning service management with standard systemd patterns. [file:13]
- Forgejo data and configuration live under `/mnt/data/srv/forgejo`, with ownership enforced by Ansible, and the service is expected to be managed and started by systemd on `srv-m1m`. [file:13]
- PostgreSQL currently uses its default OS data directory (e.g., `/var/lib/pgsql/data`), is started and enabled by the baseline playbook, and is no longer coupled to experimental paths under `/mnt/fastdata`. [file:11][file:12][file:13]
- The T480 acts as the control-plane workstation, running Ansible playbooks against `srv-m1m` to enforce this baseline, with the playbook designed to be safely re-runnable (idempotent). [file:11][file:13]

## Next steps

Planned work items to evolve this lab toward the full portfolio system:

- Design and document a dedicated PostgreSQL migration path to the performance tier (`/mnt/fastdata`), implemented as a separate Ansible playbook with clear rollback steps and its own ADR, rather than embedding it into the baseline. [file:11][file:12][file:13]
- Stand up and integrate Woodpecker CI, Prometheus, and Grafana on `srv-m1m`, using the same `/srv` + `/mnt/data` pattern, and define how they are controlled from the T480. [file:3][file:13]
- Extend the `srv-m1m-baseline.yml` once additional services are stable so that a single baseline run can converge the complete system (services, mounts, users, observability, and basic hardening). [file:13]
- Capture ADRs describing:
  - The decision to use `/srv` as a bind-mounted service root backed by `/mnt/data/srv`.
  - The choice to keep PostgreSQL on the OS disk for now and defer performance-tier migration.
  - The T480’s role as the authoritative control plane for `srv-m1m`. [file:3][file:11][file:13]

## Issues encountered

This repo documents not just the happy path, but also the problems and how they were resolved, to demonstrate real-world operational practice.

- An initial attempt to move PostgreSQL’s data directory to `/mnt/fastdata` via a systemd override caused permission and SELinux-related startup failures; this was rolled back by removing the override, fixing ownership and permissions, and restoring PostgreSQL to its default data directory. [file:11][file:12]
- SELinux labeling of the experimental PostgreSQL path under `/mnt/fastdata` required extensive `restorecon` work, reinforcing the decision to keep such migrations out of the baseline and to treat them as explicit, one-time operations documented via ADRs and runbooks. [file:11][file:12]
- Legacy fstab entries for MySQL and a bind-mounted `/home/ch1ch0` were removed to avoid hidden coupling to old layouts and to simplify the storage model around `/mnt/data` and `/srv`. [file:11][file:13]

